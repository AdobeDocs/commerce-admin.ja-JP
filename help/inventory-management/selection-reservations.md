---
title: ソースアルゴリズムと予約
description: 販売可能数量を更新し続けるためにバックグラウンドで実行されるソース選択アルゴリズムと予約システムについて説明します。
exl-id: dcd63322-fb4c-4448-b6e7-0c54350905d7
feature: Inventory, Shipping/Delivery
source-git-commit: 4d89212585fa846eb94bf83a640d0358812afbc5
workflow-type: tm+mt
source-wordcount: '2173'
ht-degree: 0%

---

# ソースアルゴリズムと予約

の心 [!DNL Inventory Management] は、倉庫や店舗内の、事実上、手持ちのすべての製品を追跡します。 ソース選択アルゴリズムと予約システムはバックグラウンドで実行され、販売可能数量の更新、チェックアウトの競合のないチェックアウト、および出荷オプションが推奨されます。

>[!NOTE]
>
>詳しくは、 [開発者向けドキュメント](https://developer.adobe.com/commerce/php/development/framework/inventory-management/) を参照してください。 [!DNL Inventory Management] システムをプログラムで使用する。

## ソース選択アルゴリズム

ソース選択アルゴリズム (SSA) は、在庫内に設定されたソースの優先順位を使用して、ソースと出荷に最適な一致を分析し、決定します。 注文出荷時に、アルゴリズムは、選択したアルゴリズムに従って、推奨されるソース、使用可能数量、および差し引き金額のリストを提供します。 [!DNL Inventory Management] は優先度アルゴリズムを提供し、新しいオプションの拡張をサポートします。

複数のソースの場所、グローバルな顧客、および様々な出荷オプションと手数料を持つ通信事業者では、実際に在庫を確認し、最適な出荷オプションを見つけるのは難しい可能性があります。 SSA は、すべてのソースにわたる在庫の販売可能数量の追跡から、出荷の計算や推奨の提示まで、お客様に対して機能します。

**在庫の追跡** - SSA は、在庫とソースを使用して、受け取った製品要求の販売チャネルを確認し、次のように使用可能な在庫を決定します。

- 1 つの在庫あたりに割り当てられたすべてのソースの集計仮想販売可能数量を計算します。集計数量 — 在庫切れしきい値（ソースあたり）
- 過剰販売から保護するために、在庫切れしきい値を売上数量から引きます
- 注文の提出時に在庫数量を予約し、注文の処理時と出荷時に在庫在庫から差し引きます。
- 負のしきい値のオプションを拡張してバックオーダーをサポート

**出荷の管理**  — アルゴリズムは、注文を処理して出荷する際に役立ちます。 アルゴリズムを実行して、商品の配送に最適なソースに関するレコメンデーションを取得したり、選択を次の場所に上書きしたりできます。

- 出荷の一部出荷。特定の場所から数個の製品のみを送信し、後で完全オーダーを完了します。
- 1 つのソースから注文全体を出荷
- 複数のソース間の異なる金額の出荷を分割し、すべての倉庫および店舗間でバランスの取れた在庫を維持

SSA は、サードパーティのサポートと、コスト効率の高い出荷を推奨するカスタムアルゴリズムに対して拡張可能です。

>[!NOTE]
>
>SSA は、Virtual 製品と Downloadable 製品で異なる機能を果たしますが、送料が発生しない場合があります。 この場合、システムは請求書を作成する際にアルゴリズムを暗黙的に実行し、常に推奨結果を使用します。 これらの結果は、Virtual および Downloadable 製品に対しては調整できません。

### ソースの優先度アルゴリズム

カスタム在庫には、販売するソースの割り当て済みリストが含まれ、ストアフロントを通じて使用可能な製品在庫を出荷します。 ソース優先度アルゴリズムは、在庫内の割り当て済ソースの順序を使用して、オーダーの請求と発送の際に、ソースごとの製品控除を推奨します。

実行時に、アルゴリズムは次の操作をおこないます。

- 上部から始まる在庫レベルで、設定された順序でソースを処理します。
- リスト内のオーダー、使用可能数量、オーダー数量に基づいて、製品ごとの出荷およびソースに数量を推奨します。
- 注文の出荷が入力されるまで、リストの下方に進みます
- リストに無効なソースが見つかった場合、そのソースをスキップします

ソースを設定、割り当て、カスタム在庫に注文するには 詳しくは、 [在庫のソースの優先順位付け](stocks-prioritize-sources.md).

次の例では、マッピングされたソースの詳細を順序、使用可能数量、および推奨ソースと推奨数量に基づいて、差し引きおよび出荷する数量で示します。 トップソースは、英国の直送船で、240 の在庫数を持ちます。

![マウンテンバイクの SSA 推奨例](assets/ssa-sources-example.png){width="600" zoomable="yes"}

### 距離優先度のアルゴリズム

「距離優先度アルゴリズム」では、出荷先住所の所在地とソース事業所を比較して、出荷を行う最も近いソースを決定します。 距離は、読み込んだデータベースの場所やGoogleの方向（運転、歩行、自転車）を使用して、ある場所から別の場所へ移動する際に費やした物理的な距離や時間によって決定できます。

出荷履行に最も近いソースを見つけるための距離と時間を計算するには、次の 2 つのオプションがあります。

- **Google MAP**  — 用途 [Google Maps Platform][1] 配送先の住所と発送元の場所（住所と GPS 座標）との間の距離と時間を計算するサービス。 このオプションでは、ソースの緯度と経度を使用します。 Google API キーは、 [ジオコーディング API][2] および [距離マトリックス API][3] 有効。 このオプションを使用するにはGoogle課金プランが必要で、Googleを通じて料金が発生する場合があります。

- **オフライン計算**  — ダウンロードおよび読み込まれたジオコードデータを使用して距離を計算し、配送先住所に最も近いソースを決定します。 このオプションでは、配送先住所と発送元の国コードを使用します。 このオプションを設定するには、開発者の支援が必要になる場合があります。開発者は、コマンドラインを使用してジオコードを最初にダウンロードし、読み込む必要があります。

設定するには、設定を選択し、Google API キーや配送先データのダウンロードなど、追加の手順を実行します。 詳しくは、 [距離優先アルゴリズムを設定する](distance-priority-algorithm.md).

### カスタムアルゴリズム

[!DNL Commerce] は、カスタム開発と拡張機能をサポートし、ソースを優先順位付けするための代替アルゴリズムを追加します。 例えば、地域に基づく優先度アルゴリズムと、在庫の費用や顧客属性に基づく優先度アルゴリズムをそれぞれ設定できます。 在庫コストが変更された場合、実装ではアルゴリズムを簡単に変更して、最も安いコストを確保できます。

## 予約

製品在庫数量を即座に減算または追加する代わりに、予約では、注文が出荷またはキャンセルされるまで在庫金額が保持されます。 予約は、在庫レベルで販売可能数量を自動的に更新するために、完全にバックエンドで機能します。

>[!NOTE]
>
>予約機能には、 `inventory.reservations.updateSalabilityStatus` メッセージキューコンシューマーが連続して実行されます。 実行中かどうかを確認するには、 `bin/magento queue:consumers:list` コマンドを使用します。 メッセージキューコンシューマーがリストに表示されていない場合は、次の操作を開始します。 `bin/magento queue:consumers:start inventory.reservations.updateSalabilityStatus`.

### 予約の注文

予約は、注文の発行時に販売可能数量から差し引かれた在庫数量に対して保留されます。 予約は在庫レベルにあり、注文が請求され、出荷され、取り消されるまで数量に対してカウントされます。 受注の出荷時に、SSA 推奨を使用するか、ソースごとに数量控除を手動で入力できます。 出荷時に、予約が自動的にクリアされ、数量が差し引かれます。 在庫の販売可能数量が再計算され、更新された数量とシステムに残っている予約金額が表示されます。

次の図は、注文中および出荷までの予約プロセスの定義に役立ちます。

![注文から配送までの予約](assets/diagram-quantity.png){width="600" zoomable="yes"}

顧客が注文を送信します。 [!DNL Commerce] 現在の在庫販売可能数量を確認します。 在庫レベルで在庫が十分にある場合、予約によって製品 SKU（その在庫）の一時保留が入力され、販売可能数量が再計算されます。

注文を請求した後、ソースから差し引きおよび出荷する製品の金額を決定します。 出荷が処理され、1 つ以上の選択したソースから顧客に送信されます。 数量は、ソース在庫数量と予約の明確な数量から自動的に差し引かれます。 詳細と例については、 [オーダー・ステータスと予約について](order-status.md).

## 予約の計算

次のイベントが発生すると、各製品の予約が作成されます。

- 顧客又は商人が注文をする。
- 顧客または商人が注文を完全に、または部分的にキャンセルした場合。
- 商人は物理的な製品の出荷を作成します。
- マーチャントは仮想またはダウンロード可能な製品の請求書を作成します。
- 商人がクレジットメモを発行します。

予約は、イベントのログに似た追加専用の操作です。 初期予約には負の数量が割り当てられます。 オーダーの処理中に作成された以降の予約はすべて正の値です。 注文が完了すると、製品のすべての予約の合計は 0 になります。

システムが新しい注文に応じて予約を発行する前に、注文を満たすのに十分な販売可能品目があるかどうかを判断します。 次の数量係数が計算に使用されます。

- **StockItem の数量**. StockItem の数量は、現在の販売チャネルのすべての物理ソースからの在庫の集計量です。 ボルチモアのソースに 20 個の製品があり、オースティンのソースに 25 個の同じ製品があり、レノのソースに 10 個がある場合の例を考えてみましょう。 これらのソースがすべて Stock A にリンクされている場合、この製品の StockItem 数は 55 (20 + 25 + 10) です。 （品目が出荷されると、在庫インデクサーは各ソースで使用可能な数量を更新します。）

- **未処理の予約**. 補償されていない初期予約がすべて合計されます。 この数は常に負の数です。 顧客 A が 10 品目の予約をし、顧客 B が品目の予約を 5 としている場合、製品の未予約は合計 —15 になります。

したがって、顧客の注文が 40(55 + -15) 単位未満であれば、商人は着信注文を満たすことができます。

オーダーの処理を完了すると（完了、キャンセル、クローズ済み）、そのオーダーの範囲内のすべての予約は、 `0`. これにより、販売可能な数量の保留がすべてクリアされます。

>[!NOTE]
>
>在庫切れのしきい値と「在庫切れのしきい値」の設定を含むバックオーダーと「在庫切れの数量以下に通知」の設定も、売上数量の計算に影響を与えますが、このトピックの範囲外です。 これらの設定について詳しくは、 [設定 [!DNL Inventory Management]](./configuration.md).

## 予約オブジェクト

予約には、次の情報が含まれます。

| パラメーター | データタイプ | 説明 |
| --- | --- | --- |
| `reservation_id` | 整数 | システムで生成された ID |
| `stock_id` | 整数 | 製品が割り当てられている在庫の ID |
| `sku` | 文字列 | 製品の SKU |
| `quantity` | 浮動小数 | この予約に含まれている項目の数 |
| `metadata` | 文字列 | この予約のイベントタイプ、オブジェクトタイプ、オブジェクト ID。 例：`{"event_type":"order_placed","object_type":"order",| "object_id":"8"}` |

{style="table-layout:auto"}

メタデータ `event_type` は次の値を持つことができます。

- `order_placed`
- `order_canceled`
- `shipment_created`
- `creditmemo_created`
- `invoice_created`

現在、メタデータオブジェクトタイプは次の条件を満たしている必要があります。 `order`の場合、オブジェクト ID は注文 ID です。

今後のリリースでは、顧客が買い物かごに品目を追加する際に予約を作成できる可能性があります。 各品目は 15 分など一定の時間予約が可能で、買い物を続けながら予約できます。 このタイプの予約を有効にした場合、メタデータに追加のタイプの情報を含めることができます。

## 予約ライフサイクル

次の例は、単純な注文に対して生成された予約のシーケンスを示しています。

1. 顧客が 25 単位の製品を注文する `SKU-1`. 予約には次の情報が含まれます。

   ```text
   reservation_id = 1
   stock_id = 1
   sku = SKU-1
   quantity = -25
   event_type = order_placed
   ```

1. 顧客は 20 品目の請求書を送信し、基本的に注文された単位の 5 つをキャンセルします。

   ```text
   reservation_id = 2
   stock_id = 1
   sku = SKU-1
   quantity = 5
   event_type = order_canceled
   ```

1. 商人は購入した 20 台を出荷します。

   ```text
   reservation_id = 3
   stock_id = 1
   sku = `SKU-1`
   quantity = 20
   event_type = shipment_created
   ```

3 人の `quantity` 値の合計は 0(-25 + 5 + 20) までです。 システムは既存の予約を変更しません。

## 処理済みの予約の削除

The `inventory_cleanup_reservations` cron ジョブは、予約データベーステーブルをクリアする SQL クエリを実行します。 デフォルトでは、毎日午前 0 時に実行されますが、時間と頻度を設定できます。 cron ジョブは、数量値の合計が 0 の完全な予約シーケンスを見つけるためにデータベースに対してクエリを実行するスクリプトを実行します。 同じ日（または他の設定時間）に発生した特定の製品に対するすべての予約が補償された場合、cron ジョブは一度に予約をすべて削除します。

The `inventory_reservations_cleanup` cron ジョブは `inventory.reservations.cleanup` メッセージキューコンシューマー。 消費者は、製品が削除された後、製品 SKU による予約を非同期で削除します。cron ジョブは、予約テーブル全体をクリアします。 消費者は、 [**カタログと同期**](../configuration-reference/catalog/inventory.md) stock オプションを使用して、ストア設定を変更できます。 詳しくは、 [メッセージキューの管理](https://experienceleague.adobe.com/docs/commerce-operations/configuration-guide/message-queues/manage-message-queues.html) （内） _設定ガイド_.

多くの場合、1 日で生成された初期予約は、同じ日に補償することができません。 この状況は、顧客が cron ジョブの開始直前に注文をした場合、または銀行振込などのオフライン支払い方法で購入した場合に発生する可能性があります。 補償された予約シーケンスは、すべてが補償されるまでデータベースに残ります。 各予約の合計は 0 なので、予約の計算には影響しません。

>[!NOTE]
>
>予約の不整合を検出および管理するために使用できる CLI コマンドがあります ( [[!DNL Inventory Management] CLI リファレンス](cli.md)) をクリックします。

### 予約の更新

注文と製品の金額の変更が完了すると、 [!DNL Commerce] は予約報酬を自動的に入力します。 これらの保留を更新または消去するために、管理者またはコードを通じて報酬を入力する必要はありません。 予約は、入力された予約によってのみ影響を受け、数量を保留したり、保留額をクリア（予約を補償）したりします。

その仕組みは次のとおりです。

- **送信済みの注文**  — 複数の製品に対して注文が送信されると、その金額の予約が入ります。 例えば、米国の Web サイトから 5 つのバックパックを注文すると、 `-5` を設定します。 販売可能量を 5 分の 1 に減らす。

- **キャンセルされた注文**  — オーダーが取り消されると（全部または一部）、報酬予約が入力され、その金額が消去されます。 例えば、3 つのバックパックをキャンセルすると、その SKU と在庫の+3 予約が入力され、保留が消去されます。 販売可能量が 3 増加します。

- **発送済みの注文**  — 受注が出荷された場合（全部または一部）、補償予約が入力され、その金額が消去されます。 例えば、2 つのバックパックを送料にすると、その SKU と在庫に対して+2 の予約が入り、保留が消去されます。 製品数量は、出荷に対して直接 2 減らされます。 計算された販売可能数量も、在庫数の減少分に対して更新されますが、予約の影響を受けなくなりました。

![予約の更新](assets/diagram-reservation.png){width="600" zoomable="yes"}

注文が完了した場合、製品がキャンセルされた場合、クレジットメモが発行された場合、すべての予約は報酬によってクリアされる必要があります。 報酬が予約をクリアしない場合は、在庫に保持されている数量（販売不可、送料なし）がある可能性があります。

>[!NOTE]
>
>予約を確認する場合は、一連のコマンドラインオプションを使用できます。 予約の確認は、コマンドラインインターフェイスを通じてのみ行うことができます。 CLI コマンドを使用する場合、開発者の支援が必要になる場合があります。 詳しくは、 [[!DNL Inventory Management] CLI リファレンス](cli.md).

保留中の注文を含む在庫の製品からすべてのソースを削除する場合、予約を停止している可能性があります。

{{$include /help/_includes/unassign-source.md}}

[1]: https://cloud.google.com/maps-platform/
[2]: https://developers.google.com/maps/documentation/geocoding/start
[3]: https://developers.google.com/maps/documentation/distance-matrix/start
